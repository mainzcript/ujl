# GitLab CI/CD Pipeline for UJL Framework
# Quality checks + GitLab Pages deployment

stages:
  - install
  - build
  - test
  - quality
  - deploy

variables:
  NODE_VERSION: '22-slim'
  PNPM_VERSION: '10.24.0'
  PLAYWRIGHT_VERSION: 'v1.56.1-jammy'

# Install dependencies once
install_deps:
  stage: install
  image: node:${NODE_VERSION}
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
  script:
    - pnpm install --frozen-lockfile
  artifacts:
    paths:
      - node_modules/
      - .pnpm-store/
      - '**/node_modules/'
    expire_in: 1 hour
  cache:
    key: dependencies-${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .pnpm-store/
      - '**/node_modules/'
      - '**/.svelte-kit/'
    policy: pull-push

# Build everything (including docs)
build_all:
  stage: build
  image: node:${NODE_VERSION}
  dependencies:
    - install_deps
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
  script:
    - export PUBLIC_TEST_MODE=false
    - pnpm run build
  artifacts:
    paths:
      - apps/docs/dist/
      - packages/*/dist/
    expire_in: 1 week
  cache:
    key: dependencies-${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .pnpm-store/
      - '**/node_modules/'
    policy: pull

# Run unit tests (existing tests)
test_unit:
  stage: test
  image: node:${NODE_VERSION}
  dependencies:
    - install_deps
    - build_all
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm install --offline
  script:
    - pnpm test
  cache:
    key: dependencies-${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .pnpm-store/
      - '**/node_modules/'
    policy: pull
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - api_failure

# Run Playwright E2E tests
test_e2e:
  stage: test
  image: mcr.microsoft.com/playwright:${PLAYWRIGHT_VERSION}
  dependencies:
    - install_deps
    - build_all
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    # Playwright-Browser sind bereits im Image vorhanden
    - cd packages/crafter
  script:
    - pnpm test:e2e:ci
  artifacts:
    when: always
    paths:
      - packages/crafter/test-results/
      - packages/crafter/playwright-report/
    reports:
      junit: packages/crafter/test-results/junit.xml
    expire_in: 1 week
  cache:
    key: dependencies-${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .pnpm-store/
      - '**/node_modules/'
    policy: pull
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - api_failure

# Run quality checks
quality_check:
  stage: quality
  image: node:${NODE_VERSION}
  dependencies:
    - install_deps
    - build_all
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
  script:
    - pnpm run lint
    - pnpm run check
  cache:
    key: dependencies-${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .pnpm-store/
      - '**/node_modules/'
      - '**/.svelte-kit/'
    policy: pull
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - api_failure

# Deploy to GitLab Pages
pages:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build_all
  script:
    - test -d apps/docs/dist || (echo "Documentation build not found" && exit 1)
    - mkdir -p public
    - cp -r apps/docs/dist/* public/
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"